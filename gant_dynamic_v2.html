<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <h2>간트 차트에 태스크 추가</h2>
    <form>
        <label>작업담당자 : <input type="text" id="taskId" /></label><br />
        <label>작업명 : <input type="text" id="taskName" /></label><br />
        <label>작업종류 :
            <select id="resource">
                <option selected>작업을 선택하세요</option>
                <option value="feature">Feature</option>
                <option value="fix">Fix</option>
                <option value="docs">Docs</option>
                <option value="design">Design</option>
                <option value="study">Study</option>
            </select>
        </label><br />
        <label>시작날짜 : <input type="date" id="startDate" /></label><br />
        <label>종료날짜 : <input type="date" id="endDate" /></label><br />
        <button type="button" onclick="addTask()">작업 추가</button>
        <br><br>
        <label>삭제할 작업명 :
            <select id="deleteTaskName"></select>
        </label><br />
        <button type="button" onclick="deleteTask()">작업 삭제</button>
    </form>
    <div id="chart_div"></div>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', { 'packages': ['gantt'] });
        google.charts.setOnLoadCallback(drawChart);

        var chart;
        var data;
        var options;

        function drawChart() {
            data = new google.visualization.DataTable();
            data.addColumn('string', 'Task ID');
            data.addColumn('string', 'Task Name');
            data.addColumn('string', 'Resource');
            data.addColumn('date', 'Start Date');
            data.addColumn('date', 'End Date');
            data.addColumn('number', 'Duration');
            data.addColumn('number', 'Percent Complete');
            data.addColumn('string', 'Dependencies');

            // 초기데이터
            data.addRows([
                [' ', ' ', ' ', new Date(), new Date(), null, 100, null]
            ]);

            options = {
                height: 400,
                gantt: {
                    trackHeight: 30
                },
                hAxis: {
                    format: 'd MMM yyyy',
                    minValue: new Date(data.getValue(0, 3)),
                    maxValue: new Date(data.getValue(0, 4))
                }
            };

            chart = new google.visualization.Gantt(document.getElementById('chart_div'));
            chart.draw(data, options);
            updateTaskList();
        }

        function taskValidation(taskName) {
            for (var i = 0; i < data.getNumberOfRows(); i++) {
                if (data.getValue(i, 1) === ' ') data.removeRow(i);
                if (data.getValue(i, 1) === taskName) return false;
            }
            return true;
        }

        function addTask() {
            let taskId = document.getElementById('taskId').value;
            let taskName = document.getElementById('taskName').value;
            if (!taskValidation(taskName)) {
                alert("작업이 중복됩니다!");
                return;
            }
            let resource = document.getElementById('resource').value;
            let startDate = new Date(document.getElementById('startDate').value);
            let endDate = new Date(document.getElementById('endDate').value);
            let dependencies = null;

            if (data.bf.length > 8) {
                options.height = options.height + 100;
            }
            if (confirm('작업을 추가하시겠습니까?') == true) {
                data.addRows([
                    [taskId, taskName, resource, startDate, endDate, null, null, dependencies]
                ]);
            }

            var minDate = options.hAxis.minValue;
            var maxDate = options.hAxis.maxValue;
            if (startDate < minDate) options.hAxis.minValue = startDate;
            if (endDate > maxDate) options.hAxis.maxValue = endDate;
            chart.draw(data, options);
            updateTaskList();
        }

        function updateTaskList() {
            let select = document.getElementById('deleteTaskName');
            select.innerHTML = '';
            for (var i = 0; i < data.getNumberOfRows(); i++) {
                let taskName = data.getValue(i, 1);
                if (taskName !== ' ') {
                    let option = document.createElement('option');
                    option.value = taskName;
                    option.textContent = taskName;
                    select.appendChild(option);
                }
            }
        }

        function deleteTask() {
            let deleteTaskName = document.getElementById('deleteTaskName').value;
            for (var i = 0; i < data.getNumberOfRows(); i++) {
                if (data.getValue(i, 1) === deleteTaskName) {
                    if (confirm(`${data.getValue(i, 1)} 작업을 삭제하시겠습니까?`) == true) {
                        data.removeRow(i);
                        chart.draw(data, options);
                        updateTaskList();
                        break;
                    }
                }
            }
        }
    </script>
</body>

</html>
<!-- 
    버그
    1. 맨 처음 데이터를 출력할 때 작업추가 버튼을 2번눌러야 들어간다.
    2. 데이터가 한개 남았을때는 삭제가 안된다
 -->